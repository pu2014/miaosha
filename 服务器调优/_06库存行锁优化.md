### 库存行锁优化

#### mysql行锁
>减库存的时候 stock >= #{amount} 在item_id = #{itemId,jdbcType=INTEGER}（如有索引）的地方加入行锁，
没有就会锁定整个table 
对item_id加上唯一索引,只需要对该数据串行操作，不需要对整个表数据串行操作

```
alter table item_stock add unique index item_id_index(item_id);
```
如果
```
<update id="decreaseStock">
    <!--
      WARNING - @mbg.generated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Mar 26 12:49:47 CST 2020.
    -->
    update item_stock
    set stock = stock - #{amount}
    where item_id = #{itemId,jdbcType=INTEGER} and stock >= #{amount}
  </update>

```

### 缓存化
1. 活动发布同步库存进缓存
>发布活动时将库存存进缓存
2. 下单交易减缓存库存
>下单时在redis上减缓存，不在数据库上直接操作
    
问题：数据库和缓存如何数据一致
3. 异步消息空间数据库内数据
>异步消息队列 rocketmq 中间件

ACID(强一致性) --> CAP --> BASE(最终一致)

问题：
1. 异步消息发送失败
2. 扣减操作执行失败
3. 下单失败无法正确回补库存（取消订单的情况）

问题本质：没有操作流水

### 库存一致性保证
1. 引入库存操作流水
2. 引入事务消息机制

--问题： 
1. redis不可用如何处理
>redis不可用是否可以去回源数据库（超卖）<br>
设计原则：宁可少买，不可超卖（也有超卖不少买，冲销量）<br>
>方案：<br>
*. redis 可以比实际数据库中少<br> block用户维护redis
*. 超时释放 （程序假死，redis扣减了，数据库没有扣减，然后消息机制一致unkonw）
这时需要设置超时释放，后台直接回滚，redis数据加上去）

2. 扣减流水时错误如何处理
>扣减流水出错

### 库存售罄
1.库存售罄标志
2.售罄后不去操作后续流程
3.售罄后通知各系统售罄（rocketMq异步消息）
4.回补上新
